# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Chesslet is a chess puzzle game built with Next.js 14. The unique twist: **every move must be a capture**, and the goal is to capture your own pieces until only one remains. The game uses a simplified 4x4 chess board with custom FEN notation.

## Development Commands

```bash
# Development
npm run dev              # Start dev server (localhost:3000)

# Build
npm run build           # Production build
npm start               # Run production build

# Testing
npm test                # Run all tests
npm run test:watch      # Run tests in watch mode
npm run test:coverage   # Run tests with coverage

# Linting
npm run lint            # Run Next.js linter

# Level Generation
node scripts/generate-levels.js  # Regenerate 100 campaign levels
```

## Architecture Overview

### Game Modes

The app supports multiple game modes via different routes:
- **Campaign Mode** (`/` - app/page.js): 100 pre-generated levels with progress tracking in localStorage
- **Random Mode** (`/random`): Generate random puzzles with difficulty selection
- **Puzzle Mode** (`/puzzle/[fen]`): Shareable puzzles via URL-encoded FEN
- **Designer Mode** (`/designer`): Create custom puzzles (in development)
- **Timed Mode** (`/timed`): Time-based challenges (in development)

### Core Game Logic (lib/)

The game logic is split into focused modules:

- **`lib/fen.js`**: Custom 4x4 FEN encoding/decoding (e.g., "KQR1/2B1/N3/PP2")
- **`lib/engine.js`**: Move validation and capture mechanics. All moves MUST be captures - pieces can only move to occupied squares
- **`lib/solver.js`**: DFS-based puzzle solver with metrics (solution count, min moves, weighted difficulty)
- **`lib/generator.js`**: Random puzzle generation with difficulty targeting
- **`lib/useGame.js`**: React hook managing game state (board, moves, history, game state transitions)
- **`lib/levels.js`**: Pre-generated campaign levels (generated by scripts/generate-levels.js)
- **`lib/constants.js`**: Shared constants (BOARD_SIZE=4, PIECES, etc.)

### Game State Management

The `useGame` hook centralizes all game state:
- Game states: `PLAYING`, `WON`, `STUCK`, `IMPOSSIBLE`
- Maintains move history for undo/reset
- Handles puzzle generation, loading, and evaluation
- Critical: The hook validates all moves through `isValidCapture()` - moves must capture a piece

### Component Architecture

- **`components/GamePage.js`**: Unified game page component used by all modes. Handles mode-specific UI/logic via props
- **`components/Board.js`**: Chess board with drag-and-drop + click-to-move
- **`components/Header.js`**: App header with mode selector modal
- **`app/page.js`**: Campaign mode page with level progression and localStorage persistence

### Level Generation

The `scripts/generate-levels.js` script generates 100 campaign levels:
- Uses **weighted piece selection** favoring P/N/K over Q/R for harder puzzles
- Employs **hill climbing** optimization for difficulty 70+ puzzles
- Phases: Very Easy (0-25), Easy (20-45), Medium (40-65), Hard (60-85), Very Hard (80-100)
- Timeout protection: 5 minute max runtime
- Output: `lib/levels.js` with all level data

### FEN Notation

This project uses a **custom 4x4 FEN format**, NOT standard chess FEN:
- Format: "row0/row1/row2/row3" (4 rows separated by `/`)
- Pieces: K, Q, R, B, N, P (uppercase only, all same color)
- Empty squares: digits 1-4
- URL-safe variant uses `-` instead of `/`
- Example: "KN2/4/4/4" = King and Knight in top row

### Styling

- **Tailwind CSS** for utility classes
- **CSS-in-JS** via Next.js styled-jsx for component-scoped styles
- Design uses custom color variables (--surface-*, --accent-*)
- Two fonts: DM Sans (UI) and Crimson Pro (serif accents)

## Key Implementation Details

### Move Validation
All moves must satisfy `isValidCapture()`:
1. Must be a valid piece movement (King, Queen, Rook, Bishop, Knight, Pawn)
2. Destination square MUST contain a piece (captures only!)
3. Path must be clear for sliding pieces (Queen, Rook, Bishop)

### Puzzle Solvability
Before showing a puzzle, always check `isSolvable()`. The solver uses DFS to verify a solution exists and calculates difficulty metrics based on:
- Solution count (fewer = harder)
- Minimum moves required
- Piece changes required
- Board complexity

### State Transitions
Campaign mode uses `isTransitioningRef` to prevent false win detection when changing levels. Always set this flag when programmatically changing levels.

### Testing
Tests use Jest + React Testing Library. Test files live in `__tests__/` directory.

## Common Patterns

### Adding a New Game Mode
1. Create route in `app/[mode]/page.js`
2. Use `GamePage` component with mode-specific props
3. Add mode to `ModeSelectModal` navigation
4. Handle mode-specific state (difficulty, timers, etc.) in the page component

### Generating Puzzles
Use `generatePuzzle()` from `lib/generator.js`:
```javascript
const puzzle = generatePuzzle({
  difficulty: 'medium',  // or null for random
  minPieces: 3,
  maxPieces: 6,
  maxAttempts: 50
});
```

### Loading Custom Puzzles
Use the `loadPuzzle()` method from `useGame` hook:
```javascript
const { loadPuzzle } = useGame();
loadPuzzle("KN2/4/4/4");  // 4x4 FEN string
```
